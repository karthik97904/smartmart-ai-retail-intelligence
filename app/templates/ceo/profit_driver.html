{% extends "base.html" %}
{% block title %} - Profit Driver Analysis{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>üí∞ Profit Driver Analyzer</h2>
        <p class="text-muted">AI-powered breakdown of what is driving your profit.</p>
    </div>
</div>

{% if report.error %}
<div class="alert alert-warning">{{ report.error }}</div>

{% else %}

<!-- Health Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white" style="background-color:#1a1a2e;">
            <div class="card-body text-center">
                <h6>Total Revenue</h6>
                <h4>‚Çπ{{ "{:,.0f}".format(report.health.total_revenue) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h6>Total Profit</h6>
                <h4>‚Çπ{{ "{:,.0f}".format(report.health.total_profit) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h6>Overall Margin</h6>
                <h4>{{ report.health.overall_margin }}%</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body text-center">
                <h6>Loss Products</h6>
                <h4>{{ report.health.loss_making_products }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- AI Insights -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body">
                <h5>ü§ñ AI Insights</h5>
                <div class="mt-3">
                    {% for insight in report.insights %}
                    <div class="alert
                        {% if insight.type == 'critical' %}alert-danger
                        {% elif insight.type == 'warning' %}alert-warning
                        {% else %}alert-success{% endif %}">
                        {{ insight.message }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">

    <!-- Top Profit Drivers -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body">
                <h5>üèÜ Top Profit Drivers</h5>
                <table class="table table-sm mt-3">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Profit</th>
                            <th>Margin %</th>
                            <th>Units</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in report.top_profit_drivers %}
                        <tr>
                            <td>{{ p.product_name }}</td>
                            <td>‚Çπ{{ "{:,.0f}".format(p.profit) }}</td>
                            <td>
                                <span class="badge
                                    {% if p.margin_pct >= 25 %}bg-success
                                    {% elif p.margin_pct >= 10 %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {{ p.margin_pct }}%
                                </span>
                            </td>
                            <td>{{ p.units }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Category Efficiency -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body">
                <h5>‚ö° Category Profit Efficiency</h5>
                <table class="table table-sm mt-3">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Profit/Unit</th>
                            <th>Score</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in report.efficiency_scores %}
                        <tr>
                            <td>{{ e.category }}</td>
                            <td>‚Çπ{{ e.profit_per_unit }}</td>
                            <td>{{ e.efficiency_score }}%</td>
                            <td>{{ e.efficiency_label }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">

    <!-- Hidden Loss Makers -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body">
                <h5>üö® Hidden Loss Makers</h5>
                <p class="text-muted small">High revenue but low profit margin products.</p>
                {% if report.hidden_loss_makers %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Revenue</th>
                            <th>Margin %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for h in report.hidden_loss_makers %}
                        <tr class="table-warning">
                            <td>{{ h.product_name }}</td>
                            <td>‚Çπ{{ "{:,.0f}".format(h.revenue) }}</td>
                            <td>{{ h.margin_pct }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-success">‚úÖ No hidden loss makers detected.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Margin Analysis -->
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body">
                <h5>üìâ Margin Risk Analysis</h5>
                <p class="text-muted small">Products with lowest profit margins.</p>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Margin %</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in report.margin_analysis %}
                        <tr>
                            <td>{{ m.product_name }}</td>
                            <td>{{ m.margin_pct }}%</td>
                            <td>
                                <span class="badge
                                    {% if m.margin_status == 'critical' %}bg-danger
                                    {% elif m.margin_status == 'low' %}bg-warning
                                    {% elif m.margin_status == 'healthy' %}bg-info
                                    {% else %}bg-success{% endif %}">
                                    {{ m.margin_status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Profit Contribution Chart -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body">
                <h5>üç© Category Profit Contribution</h5>
                <canvas id="categoryProfitChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body">
                <h5>üìä Top Products Profit vs Revenue</h5>
                <canvas id="productChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
{% if not report.error %}

// Category profit contribution chart
const catLabels = {{ report.category_contribution | map(attribute='category') | list | tojson }};
const catProfits = {{ report.category_contribution | map(attribute='profit') | list | tojson }};

new Chart(document.getElementById('categoryProfitChart'), {
    type: 'doughnut',
    data: {
        labels: catLabels,
        datasets: [{
            data: catProfits,
            backgroundColor: [
                '#1a1a2e','#e94560','#16213e',
                '#0f3460','#533483','#2b9348','#e76f51'
            ]
        }]
    },
    options: { responsive: true }
});

// Top products profit vs revenue bar chart
const prodLabels = {{ report.top_profit_drivers | map(attribute='product_name') | list | tojson }};
const prodRevenue = {{ report.top_profit_drivers | map(attribute='revenue') | list | tojson }};
const prodProfit = {{ report.top_profit_drivers | map(attribute='profit') | list | tojson }};

new Chart(document.getElementById('productChart'), {
    type: 'bar',
    data: {
        labels: prodLabels,
        datasets: [
            {
                label: 'Revenue',
                data: prodRevenue,
                backgroundColor: '#1a1a2e'
            },
            {
                label: 'Profit',
                data: prodProfit,
                backgroundColor: '#e94560'
            }
        ]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
    }
});

{% endif %}
</script>
{% endblock %}